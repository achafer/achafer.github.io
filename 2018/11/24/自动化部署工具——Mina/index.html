<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>半自动化部署工具——Mina · 远山淡影</title><meta name="description" content="半自动化部署工具——Mina - 阿扯"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/gandalfr.css"><link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/solarized-light.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.ache.fun/atom.xml" title="远山淡影"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/lion.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">半自动化部署工具——Mina</h1><div class="tags"><a href="/tags/Ruby/" class="tag-title">#Ruby</a><a href="/tags/工具/" class="tag-title">#工具</a></div><div class="post-info">Nov 24, 2018</div><div class="post-content"><p>昨天参加了一个技术沙龙，收获蛮多，在这里记录下其中的一个半自动化部署化工具Mina的使用方法。</p>
<h3 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h3><p>考虑到项目所处的阶段或者项目的规模，很多项目并没有精力和成本使用一套完善的CI/CD系统，但手动部署又过于琐碎和重复，简单的部署使用Shell脚本就够了，但Shell脚本的可读性差，处理复杂的场景也有点力不从心，比如管理脚本多个版本等。Mina使用Ruby实现DSL。相比起Shell，Mina更加容易阅读和维护，在运行时，mina会把Ruby文件转换成Bash脚本，运行速度也有保障。当然，没有最好的工具，只有适合自己的工具。</p>
<h3 id="安装使用"><a href="#安装使用" class="headerlink" title="安装使用"></a>安装使用</h3><p>官方的<a href="https://github.com/mina-deploy/mina/blob/master/docs/getting_started.md" target="_blank" rel="noopener">栗子</a>已经很详细了，这里简单解析下使用MIna部署Vue的前端项目流程：</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">require</span> <span class="string">"mina/git"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Basic settings:</span></span><br><span class="line"><span class="comment"># repository branch needed by mina/git</span></span><br><span class="line"></span><br><span class="line">set <span class="symbol">:application_name</span>, <span class="string">"foobar"</span></span><br><span class="line">set <span class="symbol">:domain</span>, <span class="string">"foobar.com"</span></span><br><span class="line">set <span class="symbol">:deploy_to</span>, <span class="string">"/var/www/foobar.com"</span></span><br><span class="line">set <span class="symbol">:repository</span>, <span class="string">"git@github.com:my/vue-project.git"</span></span><br><span class="line">set <span class="symbol">:branch</span>, <span class="string">"master"</span></span><br><span class="line">set <span class="symbol">:image</span>, <span class="string">"hub.yourdocker.com:latest"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Optional settings:</span></span><br><span class="line">set <span class="symbol">:user</span>, <span class="string">"foobar"</span>          <span class="comment"># Username in the server to SSH to.</span></span><br><span class="line">set <span class="symbol">:port</span>, <span class="string">"30000"</span>           <span class="comment"># SSH port number.</span></span><br><span class="line">set <span class="symbol">:forward_agent</span>, <span class="literal">true</span>     <span class="comment"># SSH forward_agent.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Shared dirs and files will be symlinked into the app-folder by the 'deploy:link_shared_paths' step.</span></span><br><span class="line"><span class="comment"># Some plugins already add folders to shared_dirs like `mina/rails` add `public/assets`, `vendor/bundle` and many more</span></span><br><span class="line"><span class="comment"># run `mina -d` to see all folders and files already included in `shared_dirs` and `shared_files`</span></span><br><span class="line"><span class="comment"># 共享node_modules 节约空间</span></span><br><span class="line">set <span class="symbol">:shared_dirs</span>, fetch(<span class="symbol">:shared_dirs</span>, []).push(<span class="string">"node_modules"</span>)</span><br><span class="line"><span class="comment"># set :shared_files, fetch(:shared_files, []).push('config/database.yml', 'config/secrets.yml')</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This task is the environment that is loaded for all remote run commands, such as</span></span><br><span class="line"><span class="comment"># `mina deploy` or `mina rake`.</span></span><br><span class="line">task <span class="symbol">:remote_environment</span> <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># 可以设置NodeJS 的版本、安装yarn等操作</span></span><br><span class="line">  <span class="comment"># If you're using rbenv, use this to load the rbenv environment.</span></span><br><span class="line">  <span class="comment"># Be sure to commit your .ruby-version or .rbenv-version to your repository.</span></span><br><span class="line">  <span class="comment"># invoke :'rbenv:load'</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># For those using RVM, use this to load an RVM version<span class="doctag">@gemset</span>.</span></span><br><span class="line">  <span class="comment"># invoke :'rvm:use', 'ruby-1.9.3-p125<span class="doctag">@default</span>'</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Put any custom commands you need to run at setup</span></span><br><span class="line"><span class="comment"># All paths in `shared_dirs` and `shared_paths` will be created on their own.</span></span><br><span class="line">task <span class="symbol">:setup</span> <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># 安装Node.Js 的版本</span></span><br><span class="line">  <span class="comment"># command %&#123;rbenv install 2.3.0 --skip-existing&#125;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">desc <span class="string">"Deploys the current version to the server."</span></span><br><span class="line">task <span class="symbol">:deploy</span> <span class="keyword">do</span></span><br><span class="line">  <span class="comment"># uncomment this line to make sure you pushed your local branch to the remote origin</span></span><br><span class="line">  invoke <span class="symbol">:<span class="string">'git:ensure_pushed'</span></span></span><br><span class="line">  deploy <span class="keyword">do</span></span><br><span class="line">    <span class="comment"># Put things that will set up an empty directory into a fully set-up</span></span><br><span class="line">    <span class="comment"># instance of your project.</span></span><br><span class="line">    invoke <span class="symbol">:<span class="string">'git:clone'</span></span></span><br><span class="line">    invoke <span class="symbol">:<span class="string">'deploy:link_shared_paths'</span></span></span><br><span class="line">    command <span class="string">%&#123;yarn install&#125;</span></span><br><span class="line">    invoke <span class="symbol">:build</span></span><br><span class="line">    invoke <span class="symbol">:<span class="string">'deploy:cleanup'</span></span></span><br><span class="line"></span><br><span class="line">    on <span class="symbol">:launch</span> <span class="keyword">do</span></span><br><span class="line">      in_path(fetch(<span class="symbol">:current_path</span>)) <span class="keyword">do</span></span><br><span class="line">        command <span class="string">%&#123;mkdir -p tmp/&#125;</span></span><br><span class="line">        command <span class="string">%&#123;touch tmp/restart.txt&#125;</span></span><br><span class="line">        command <span class="string">%&#123;docker run <span class="subst">#&#123;fetch <span class="symbol">:image</span>&#125;</span>&#125;</span> <span class="comment"># can also use compose pull</span></span><br><span class="line">      <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># you can use `run :local` to run tasks on local machine before of after the deploy scripts</span></span><br><span class="line">  <span class="comment"># run(:local)&#123; say 'done' &#125;</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># 构建 docker镜像</span></span><br><span class="line">task <span class="symbol">:build</span> <span class="keyword">do</span></span><br><span class="line">  command <span class="string">%(docker build -t <span class="subst">#&#123;fetch <span class="symbol">:image</span>&#125;</span> .)</span></span><br><span class="line">  command <span class="string">%(docker push <span class="subst">#&#123;fetch <span class="symbol">:image</span>&#125;</span>)</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># For help in making your deploy script, see the Mina documentation:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  - https://github.com/mina-deploy/mina/tree/master/docs</span></span><br></pre></td></tr></table></figure>
<p>前端项目的Dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> nginx:latest</span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span> dist /usr/share/nginx/html</span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line">CMD ["nginx", "-g", "daemon off;"]</span><br></pre></td></tr></table></figure>
<p>在官方文档<a href="https://github.com/mina-deploy/mina/blob/0dd5fdb8bb82a180d35e1fc033de2fac48257e30/docs/how_mina_works.md#how-mina-works" target="_blank" rel="noopener">How Mina Works?</a>中介绍了Mina在server上的目录结构:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── current -&gt; /home/deploy/www/example.com/releases/91</span><br><span class="line">├── releases</span><br><span class="line">│   ├── 86</span><br><span class="line">│   ├── 87</span><br><span class="line">│   ├── 88</span><br><span class="line">│   ├── 89</span><br><span class="line">│   ├── 90</span><br><span class="line">│   └── 91</span><br><span class="line">├── scm</span><br><span class="line">├── shared</span><br><span class="line">│   ├── bundle</span><br><span class="line">│   ├── config</span><br><span class="line">│   ├── log</span><br><span class="line">│   ├── public</span><br><span class="line">│   ├── tmp</span><br><span class="line">│   └── vendor</span><br><span class="line">└── tmp</span><br></pre></td></tr></table></figure>
<p>其中<code>current</code>是指向当前版本的软连接；<code>releases</code>记录了每次部署的源码，为线上回退版本提供了方便，<code>scm</code>记录版本控制的信息，GIt就是项目下<code>.git</code>目录，<code>shared</code>包含在发布之间保存的文件夹和文件(日志、上传、配置，…) )， <code>tmp</code>用来放一些构建产生的临时文件。</p>
<p><a href="https://github.com/mina-deploy/mina/blob/master/docs/deploying.md" target="_blank" rel="noopener">Deploying</a>描述了部署过程详细解析。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>使用下来，感觉mina对于脚本语言的项目管理考虑的十分到位，虽然JavaScript也有类似的工具，比如<a href="https://github.com/shipitjs/shipit" target="_blank" rel="noopener">Shipit</a>，但个人更喜欢Ruby的实现DSL的表达力。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/12/09/Ruby元编程学习笔记——法术手册/" class="prev">PREV</a><a href="/2018/11/18/布莱叶盲文/" class="next">NEXT</a></div><div class="copyright"><p>© 2018 <a href="https://blog.ache.fun">阿扯</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/MikeCoder/hexo-theme-gandalfr" target="_blank">hexo-theme-gandalfr</a>.</p></div></footer></div><script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" crossorigin="anonymous"></script><script src="//cdn.bootcss.com/jquery/3.1.1/jquery.js" crossorigin="anonymous"></script><script>$(document).ready(function() { $('pre').each(function(i, block) { hljs.highlightBlock(block); }); });</script></body></html>