<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title>Ruby元编程学习笔记——法术手册 · 远山淡影</title><meta name="description" content="Ruby元编程学习笔记——法术手册 - 阿扯"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/gandalfr.css"><link rel="stylesheet" href="https://highlightjs.org/static/demo/styles/solarized-light.css"><link rel="search" type="application/opensearchdescription+xml" href="https://blog.ache.fun/atom.xml" title="远山淡影"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/lion.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">Ruby元编程学习笔记——法术手册</h1><div class="tags"><a href="/tags/Ruby/" class="tag-title">#Ruby</a></div><div class="post-info">Dec 9, 2018</div><div class="post-content"><p>Ruby法术手册为《Ruby元编程》书中的精华，记录下笔记以便之后慢慢回味。</p>
<h3 id="环绕别名"><a href="#环绕别名" class="headerlink" title="环绕别名"></a>环绕别名</h3><p>Around Alias</p>
<p>从一个重新定义的方法中调用原始的、被重命名的版本。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String</span></span></span><br><span class="line">    alias_method <span class="symbol">:old_reverse</span>, <span class="symbol">:reverse</span></span><br><span class="line">   	</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverse</span></span></span><br><span class="line">        <span class="string">"x<span class="subst">#&#123;old_reverse)x&#125;</span>"</span></span><br><span class="line">	<span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="string">"abc"</span>.reverse <span class="comment"># =&gt; "xcbax"</span></span><br></pre></td></tr></table></figure>
<h3 id="白板类"><a href="#白板类" class="headerlink" title="白板类"></a>白板类</h3><p>Blank Slate</p>
<p>移除一个对象中的所有方法，以便把它们转换成幽灵方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(name, *args)</span></span></span><br><span class="line">        <span class="string">"a Ghost Method"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">obj = C.new</span><br><span class="line">obj.to_s        <span class="comment"># =&gt; #&lt;C:0x00.....</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> &lt; BasicObject</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(name, *args)</span></span></span><br><span class="line">        <span class="string">"a Ghost Mehtod"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">blank_slate = D.new</span><br><span class="line">blank_slate.to_s.  <span class="comment"># =&gt; "a Ghost Method"</span></span><br></pre></td></tr></table></figure>
<h3 id="类扩展"><a href="#类扩展" class="headerlink" title="类扩展"></a>类扩展</h3><p>Class Extension</p>
<p>通过向类的单件类中加入模块来定义类方法，是对象扩展的一个特例</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>;</span> <span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_method</span></span></span><br><span class="line">        <span class="string">'a class method'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> &lt;&lt; C</span></span><br><span class="line">    <span class="keyword">include</span> M</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">C.my_method <span class="comment"># =&gt; "a class method"</span></span><br></pre></td></tr></table></figure>
<h3 id="类实例变量"><a href="#类实例变量" class="headerlink" title="类实例变量"></a>类实例变量</h3><p>Class Instance Variable</p>
<p>在一个Class对象的实例变量中存储类级别的状态</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">    @my_class_instance_variable = <span class="string">"some value"</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">class_attribute</span></span></span><br><span class="line">        @my_class_instance_variable</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">C.class_attribute <span class="comment"># =&gt; "some value"</span></span><br></pre></td></tr></table></figure>
<h3 id="类宏"><a href="#类宏" class="headerlink" title="类宏"></a>类宏</h3><p>在类定义中使用一个类方法。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span>;</span> <span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> &lt;&lt; C</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_macro</span><span class="params">(arg)</span></span></span><br><span class="line">        <span class="string">"my_macro(<span class="subst">#&#123;arg&#125;</span>) called"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">    my_macro <span class="symbol">:x</span> <span class="comment"># =&gt; "my_macro(x) called"</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="洁净室"><a href="#洁净室" class="headerlink" title="洁净室"></a>洁净室</h3><p>使用对象作为执行块的上下文环境</p>
<p>实际上就是通过 instance_eval 限定执行块的作用域。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CleanRoom</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">a_useful_method</span><span class="params">(x)</span></span>; x * <span class="number">2</span>; <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">CleanRoom.new.instance_eval &#123; a_useful_method(<span class="number">3</span>) &#125; <span class="comment"># =&gt; 6</span></span><br></pre></td></tr></table></figure>
<h3 id="代码处理器"><a href="#代码处理器" class="headerlink" title="代码处理器"></a>代码处理器</h3><p>处理从外部获得的字符串代码</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">File.readlines(<span class="string">"a_file_containing_lines_of_ruby.txt"</span> ).each <span class="keyword">do</span> <span class="params">|line|</span></span><br><span class="line">    puts <span class="string">"<span class="subst">#&#123;line.chomp&#125;</span> ==&gt; <span class="subst">#&#123;eval(line)&#125;</span>"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment"># &gt;&gt; 1 + 1 ==&gt; 2</span></span><br><span class="line"><span class="comment"># &gt;&gt; 3 * 2 ==&gt; 6</span></span><br><span class="line"><span class="comment"># &gt;&gt; Math.log10(100) ==&gt; 2.0</span></span><br></pre></td></tr></table></figure>
<h3 id="上下文探针"><a href="#上下文探针" class="headerlink" title="上下文探针"></a>上下文探针</h3><p>执行块来获取对象上下文中的信息。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></span><br><span class="line">        @x = <span class="string">"a private instance variable"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">obj = C.new</span><br><span class="line">obj.instance_eval &#123; @x &#125; <span class="comment"># =&gt; "a private instance variable"</span></span><br></pre></td></tr></table></figure>
<h3 id="延迟执行"><a href="#延迟执行" class="headerlink" title="延迟执行"></a>延迟执行</h3><p>在 proc 或  lambda中存储一段代码及其上下文，用于以后执行。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">store</span><span class="params">(&amp;block)</span></span></span><br><span class="line">        @my_code_capsule = block</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">execute</span></span></span><br><span class="line">        @my_code_capsule.call</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">obj = C.new</span><br><span class="line">obj.store &#123; $X = <span class="number">1</span> &#125;</span><br><span class="line">$X = <span class="number">0</span></span><br><span class="line">obj.execute</span><br><span class="line">$X <span class="comment"># =&gt; 1</span></span><br></pre></td></tr></table></figure>
<h3 id="动态派发"><a href="#动态派发" class="headerlink" title="动态派发"></a>动态派发</h3><p>在运行时决定调用哪个方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">method_to_call = <span class="symbol">:reverse</span></span><br><span class="line">obj = <span class="string">"abc"</span></span><br><span class="line">obj.send(method_to_call) <span class="comment"># =&gt; "cba"</span></span><br></pre></td></tr></table></figure>
<h3 id="动态方法"><a href="#动态方法" class="headerlink" title="动态方法"></a>动态方法</h3><p>在运行时才决定如何定义一个方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">C.class_eval <span class="keyword">do</span></span><br><span class="line">    define_method <span class="symbol">:my_method</span> <span class="keyword">do</span></span><br><span class="line">        <span class="string">"a dynamic method"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">obj = C.new</span><br><span class="line">obj.my_method <span class="comment"># =&gt; "a dynamic method"</span></span><br></pre></td></tr></table></figure>
<h3 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h3><p>把不能对应某个方法名的消息转发给另外一个对象。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDynamicProxy</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(target)</span></span></span><br><span class="line">        @target = target</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(name, *args, &amp;block)</span></span></span><br><span class="line">        <span class="string">"result: <span class="subst">#&#123;@target.send(name, *args, &amp;block)&#125;</span>"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">obj = MyDynamicProxy.new(<span class="string">"a string"</span> )</span><br><span class="line">obj.reverse <span class="comment"># =&gt; "result: gnirts a"</span></span><br></pre></td></tr></table></figure>
<h3 id="扁平作用域"><a href="#扁平作用域" class="headerlink" title="扁平作用域"></a>扁平作用域</h3><p>使用闭包在两个作用域之间共享变量</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">an_attribute</span></span></span><br><span class="line">        @attr</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">obj = C.new</span><br><span class="line">a_variable = <span class="number">100</span></span><br><span class="line"><span class="comment"># flat scope:</span></span><br><span class="line">obj.instance_eval <span class="keyword">do</span></span><br><span class="line">    @attr = a_variable</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">obj.an_attribute <span class="comment"># =&gt; 100</span></span><br></pre></td></tr></table></figure>
<h3 id="幽灵方法"><a href="#幽灵方法" class="headerlink" title="幽灵方法"></a>幽灵方法</h3><p>响应一个没有关联方法的消息</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">method_missing</span><span class="params">(name, *args)</span></span></span><br><span class="line">        name.to_s.reverse</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">obj = C.new</span><br><span class="line">obj.my_ghost_method <span class="comment"># =&gt; "dohtem_tsohg_ym"</span></span><br></pre></td></tr></table></figure>
<h3 id="钩子方法"><a href="#钩子方法" class="headerlink" title="钩子方法"></a>钩子方法</h3><p>覆写一个方法来截获对象模型事件。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$INHERITORS = []</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">self</span>.<span class="title">inherited</span><span class="params">(subclass)</span></span></span><br><span class="line">        $INHERITORS &lt;&lt; subclass</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> &lt; C</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span> &lt; C</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">F</span> &lt; E</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">$INHERITORS <span class="comment"># =&gt; [D, E, F]</span></span><br></pre></td></tr></table></figure>
<h3 id="内核方法"><a href="#内核方法" class="headerlink" title="内核方法"></a>内核方法</h3><p>在 Kernel 模块中定义一个方法，使之对所有对象都可用。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">Kernel</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">a_method</span></span></span><br><span class="line">        <span class="string">"a kernel method"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">a_method <span class="comment"># =&gt; "a kernel method"</span></span><br></pre></td></tr></table></figure>
<h3 id="惰性实例变量"><a href="#惰性实例变量" class="headerlink" title="惰性实例变量"></a>惰性实例变量</h3><p>当第一次访问一个实例变量时才对之进行初始化。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">attribute</span></span></span><br><span class="line">        @attribute = @attribute <span class="params">||</span> <span class="string">"some value"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">obj = C.new</span><br><span class="line">obj.attribute <span class="comment"># =&gt; "some value"</span></span><br></pre></td></tr></table></figure>
<h3 id="拟态方法"><a href="#拟态方法" class="headerlink" title="拟态方法"></a>拟态方法</h3><p>把一个方法伪装成另外一种语言构件。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">BaseClass</span><span class="params">(name)</span></span></span><br><span class="line">    name == <span class="string">"string"</span> ? String : Object</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> &lt; BaseClass "<span class="title">string</span>" <span class="comment"># a method that looks like a class</span></span></span><br><span class="line">    <span class="keyword">attr_accessor</span> <span class="symbol">:an_attribute</span> <span class="comment"># 伪装成关键字的方法</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">obj = C.new</span><br><span class="line">obj.an_attribute = <span class="number">1</span> <span class="comment"># 伪装成属性的方法</span></span><br></pre></td></tr></table></figure>
<h3 id="猴子打补丁"><a href="#猴子打补丁" class="headerlink" title="猴子打补丁"></a>猴子打补丁</h3><p>修改已有类的特性，书中说应该少用。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"abc"</span>.reverse <span class="comment"># =&gt; "cba"</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverse</span></span></span><br><span class="line">        <span class="string">"override"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="string">"abc"</span>.reverse <span class="comment"># =&gt; "override"</span></span><br></pre></td></tr></table></figure>
<h3 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h3><p>在一个模块中定义常量，以防止命名冲突。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">MyNamespace</span></span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Array</span></span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">to_s</span></span></span><br><span class="line">            <span class="string">"my class"</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">Array.new <span class="comment"># =&gt; []</span></span><br><span class="line">MyNamespace::Array.new <span class="comment"># =&gt; my class</span></span><br></pre></td></tr></table></figure>
<h3 id="空指针保护"><a href="#空指针保护" class="headerlink" title="空指针保护"></a>空指针保护</h3><p>用“或”操作符覆写一个空应用。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">x = <span class="literal">nil</span></span><br><span class="line">y = x <span class="params">||</span> <span class="string">"a value"</span> <span class="comment"># =&gt; "a value"</span></span><br></pre></td></tr></table></figure>
<h3 id="对象扩展"><a href="#对象扩展" class="headerlink" title="对象扩展"></a>对象扩展</h3><p>通过给一个对象 eigenclass 混入模块来定义单件方法。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">obj = Object.new</span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_method</span></span></span><br><span class="line">        <span class="string">'a singleton method'</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> &lt;&lt; obj</span></span><br><span class="line">    <span class="keyword">include</span> M</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">obj.my_method <span class="comment"># =&gt; "a singleton method"</span></span><br></pre></td></tr></table></figure>
<h3 id="打开类"><a href="#打开类" class="headerlink" title="打开类"></a>打开类</h3><p>修改已有的类</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">String</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_string_method</span></span></span><br><span class="line">        <span class="string">"my method"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="string">"abc"</span>.my_string_method <span class="comment"># =&gt; "my method"</span></span><br></pre></td></tr></table></figure>
<h3 id="下包含包装器"><a href="#下包含包装器" class="headerlink" title="下包含包装器"></a>下包含包装器</h3><p>调用一个用prepend方式覆写的方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">M</span></span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">reverse</span></span></span><br><span class="line">        <span class="string">"x&#123;super&#125;x"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">String.class_eval <span class="keyword">do</span></span><br><span class="line">    prepend M</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="string">"abc"</span>.reverse <span class="comment"># =&gt; "xcbax</span></span><br></pre></td></tr></table></figure>
<h3 id="细化"><a href="#细化" class="headerlink" title="细化"></a>细化</h3><p>为类打补丁，作用范围仅到文件结束，或仅限于包含的模块的作用与中。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">MyRefinement</span></span></span><br><span class="line">    refine String <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">reverse</span></span></span><br><span class="line">            <span class="string">"my reverse"</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="string">"abc"</span>.reverse 	<span class="comment"># =&gt; "cba"</span></span><br><span class="line">using MyRefinement</span><br><span class="line"><span class="string">"abc"</span>.reverse	<span class="comment"># =&gt; "my reverse"</span></span><br></pre></td></tr></table></figure>
<h3 id="细化封装器"><a href="#细化封装器" class="headerlink" title="细化封装器"></a>细化封装器</h3><p>在细化中调用非细化的方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">StringRefinement</span></span></span><br><span class="line">    refine String <span class="keyword">do</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">reverse</span></span></span><br><span class="line">            <span class="string">"x&#123;super&#125;x"</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">using StringRefinement</span><br><span class="line"><span class="string">"abc"</span>.reverse	<span class="comment"># =&gt; "xcbax"</span></span><br></pre></td></tr></table></figure>
<h3 id="沙盒"><a href="#沙盒" class="headerlink" title="沙盒"></a>沙盒</h3><p>在一个安全的环境中执行为授信的代码</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sandbox</span><span class="params">(&amp;code)</span></span></span><br><span class="line">    proc &#123;</span><br><span class="line">        $SAFE = <span class="number">2</span></span><br><span class="line">        <span class="keyword">yield</span></span><br><span class="line">        &#125;.call</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    sandbox &#123; File.delete <span class="string">'a_file'</span> &#125;</span><br><span class="line"><span class="keyword">rescue</span> Exception =&gt; ex</span><br><span class="line">    ex <span class="comment"># =&gt; #&lt;SecurityError: Insecure operation `delete</span></span><br></pre></td></tr></table></figure>
<h3 id="作用域门"><a href="#作用域门" class="headerlink" title="作用域门"></a>作用域门</h3><p>用 class、module 或 def 关键字来隔离作用域</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span></span><br><span class="line"><span class="keyword">defined</span>? a <span class="comment"># =&gt; "local-variable"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">module</span> <span class="title">MyModule</span></span></span><br><span class="line">    b = <span class="number">1</span></span><br><span class="line">    <span class="keyword">defined</span>? a <span class="comment"># =&gt; nil</span></span><br><span class="line">    <span class="keyword">defined</span>? b <span class="comment"># =&gt; "local-variable"</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">defined</span>? a <span class="comment"># =&gt; "local-variable"</span></span><br><span class="line"><span class="keyword">defined</span>? b <span class="comment"># =&gt; nil</span></span><br></pre></td></tr></table></figure>
<h3 id="Self-Yield"><a href="#Self-Yield" class="headerlink" title="Self Yield"></a>Self Yield</h3><p>把 self 传给当前块</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span></span><br><span class="line">    <span class="keyword">attr_accessor</span> <span class="symbol">:name</span>, <span class="symbol">:surname</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">initialize</span></span></span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">self</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">joe = Person.new <span class="keyword">do</span> <span class="params">|p|</span></span><br><span class="line">    p.name = <span class="string">'Joe'</span></span><br><span class="line">    p.surname = <span class="string">'Smith'</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<h3 id="共享作用域"><a href="#共享作用域" class="headerlink" title="共享作用域"></a>共享作用域</h3><p>在同一个扁平作用域的多个上下文中共享变量</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">lambda &#123;</span><br><span class="line">    shared = <span class="number">10</span></span><br><span class="line">    <span class="keyword">self</span>.<span class="keyword">class</span>.class_eval <span class="keyword">do</span></span><br><span class="line">        define_method <span class="symbol">:counter</span> <span class="keyword">do</span></span><br><span class="line">            shared</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        define_method <span class="symbol">:down</span> <span class="keyword">do</span></span><br><span class="line">            shared -= <span class="number">1</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">&#125;.call</span><br><span class="line"></span><br><span class="line">counter <span class="comment"># =&gt; 10</span></span><br><span class="line"><span class="number">3</span>.times &#123; down &#125;</span><br><span class="line">counter <span class="comment"># =&gt; 7</span></span><br></pre></td></tr></table></figure>
<h3 id="单件方法"><a href="#单件方法" class="headerlink" title="单件方法"></a>单件方法</h3><p>在一个对象上定义一个方法</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">obj = <span class="string">"abc"</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> &lt;&lt; obj</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">my_singleton_method</span></span></span><br><span class="line">        <span class="string">"x"</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">obj.my_singleton_method <span class="comment"># =&gt; "x"</span></span><br></pre></td></tr></table></figure>
<h3 id="代码字符串"><a href="#代码字符串" class="headerlink" title="代码字符串"></a>代码字符串</h3><p>执行一段表示 Ruby 代码的字符串。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">my_string_of_code = <span class="string">"1 + 1"</span></span><br><span class="line">eval(my_string_of_code) <span class="comment"># =&gt; 2</span></span><br></pre></td></tr></table></figure>
<h3 id="符号到-Proc"><a href="#符号到-Proc" class="headerlink" title="符号到 Proc"></a>符号到 Proc</h3><p>把一个符号转换为调用单个方法的代码块。</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>].map(&amp;<span class="symbol">:even?</span>) <span class="comment"># =&gt; [false, true, false, true]</span></span><br></pre></td></tr></table></figure>
</div></article></div></main><footer><div class="paginator"><a href="/2018/12/23/Golang中的Module/" class="prev">PREV</a><a href="/2018/11/24/自动化部署工具——Mina/" class="next">NEXT</a></div><div class="copyright"><p>© 2018 - 2019 <a href="https://blog.ache.fun">阿扯</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/MikeCoder/hexo-theme-gandalfr" target="_blank">hexo-theme-gandalfr</a>.</p></div></footer></div><script src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js" crossorigin="anonymous"></script><script src="//cdn.bootcss.com/jquery/3.1.1/jquery.js" crossorigin="anonymous"></script><script>$(document).ready(function() { $('pre').each(function(i, block) { hljs.highlightBlock(block); }); });</script></body></html>